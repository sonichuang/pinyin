<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è‹±æ–‡åœ°å€è½¬æ¢å™¨ (V3.0)</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #cbd5e1; --text: #334155; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #1e293b; margin-bottom: 25px; font-size: 22px; }
        
        /* è¾“å…¥åŒº */
        .input-section { margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; color: #1e293b; }
        textarea { width: 100%; height: 80px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.2s; }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* æŒ‰é’®åŒº */
        .controls { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; color: white; }
        button:hover { opacity: 0.9; }
        .btn-convert { background: var(--primary); flex-grow: 2; font-size: 16px; }
        .btn-clear { background: #94a3b8; }
        .btn-zip { background: #f59e0b; }
        .zip-manual { padding: 0 15px; border: 1px solid var(--border); border-radius: 6px; width: 100px; text-align: center; font-size: 14px; }

        /* ç»“æœå±•ç¤º */
        .result-section { margin-bottom: 30px; }
        .result-box { background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; font-family: "Monaco", "Consolas", monospace; font-size: 16px; line-height: 1.6; }

        /* æ‹†åˆ†è¡¨æ ¼ */
        .split-section { border-top: 2px dashed #e2e8f0; padding-top: 20px; }
        .split-grid { display: grid; grid-template-columns: 100px 1fr 60px; gap: 10px; align-items: center; margin-bottom: 8px; }
        .field-label { font-weight: 600; color: #64748b; text-align: right; font-size: 14px; }
        .field-value { padding: 8px 12px; background: #f1f5f9; border-radius: 6px; border: 1px solid var(--border); font-family: monospace; color: #334155; min-height: 20px; word-break: break-all; font-size: 14px; }
        .btn-copy-mini { padding: 5px 0; font-size: 12px; background: #10b981; width: 100%; }

        @media (max-width: 600px) {
            .split-grid { grid-template-columns: 1fr; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .field-label { text-align: left; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‡¨ğŸ‡³ ä¸­æ–‡åœ°å€ -> ğŸ‡ºğŸ‡¸ è‹±æ–‡æ‹¼éŸ³è½¬æ¢å™¨ V3</h1>
    
    <div class="input-section">
        <label>è¾“å…¥ä¸­æ–‡ä¿¡æ¯ (åŒ…å«å§“åã€ç”µè¯ã€åœ°å€)ï¼š</label>
        <textarea id="input" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ 13800138000 ç¦å»ºçœæ³‰å·å¸‚ä¸°æ³½åŒºä¸œæµ·è¡—é“æµ·æ˜Ÿè¡—..."></textarea>
    </div>

    <div class="controls">
        <button class="btn-clear" onclick="clearAll()">æ¸…ç©º</button>
        <button class="btn-zip" onclick="searchZip()">ğŸ” æœé‚®ç¼–</button>
        <input type="text" id="manualZip" class="zip-manual" placeholder="å¡«å…¥é‚®ç¼–">
        <button class="btn-convert" onclick="processAll()">å¼€å§‹è½¬æ¢</button>
    </div>

    <div class="result-section">
        <label>å®Œæ•´æ‹¼éŸ³åœ°å€ (Full Line)ï¼š</label>
        <textarea id="fullResult" class="result-box" readonly onclick="this.select()"></textarea>
    </div>

    <div class="split-section">
        <label style="margin-bottom: 15px; display:block;">è¯¦ç»†æ‹†åˆ† (Field Breakdown)ï¼š</label>
        
        <div class="split-grid">
            <div class="field-label">å§“ Surname</div>
            <div class="field-value" id="resSurname"></div>
            <button class="btn-copy-mini" onclick="copyText('resSurname')">å¤åˆ¶</button>
        </div>
        <div class="split-grid">
            <div class="field-label">å First Name</div>
            <div class="field-value" id="resFirstName"></div>
            <button class="btn-copy-mini" onclick="copyText('resFirstName')">å¤åˆ¶</button>
        </div>
        <div class="split-grid">
            <div class="field-label">ç”µè¯ Phone</div>
            <div class="field-value" id="resPhone"></div>
            <button class="btn-copy-mini" onclick="copyText('resPhone')">å¤åˆ¶</button>
        </div>
        <div class="split-grid">
            <div class="field-label">çœ Province</div>
            <div class="field-value" id="resProv"></div>
            <button class="btn-copy-mini" onclick="copyText('resProv')">å¤åˆ¶</button>
        </div>
        <div class="split-grid">
            <div class="field-label">å¸‚ City</div>
            <div class="field-value" id="resCity"></div>
            <button class="btn-copy-mini" onclick="copyText('resCity')">å¤åˆ¶</button>
        </div>
        <div class="split-grid">
            <div class="field-label">åœ°å€ Address</div>
            <div class="field-value" id="resAddr"></div>
            <button class="btn-copy-mini" onclick="copyText('resAddr')">å¤åˆ¶</button>
        </div>
        <div class="split-grid">
            <div class="field-label">é‚®ç¼– Zip</div>
            <div class="field-value" id="resZip"></div>
            <button class="btn-copy-mini" onclick="copyText('resZip')">å¤åˆ¶</button>
        </div>
    </div>
</div>

<script>
    const { pinyin } = pinyinPro;

    // å¤å§“åˆ—è¡¨ (ç”¨äºåŒºåˆ†å§“å’Œå)
    const COMPOUND_SURNAMES = [
        "æ¬§é˜³", "å¤ªå²", "ç«¯æœ¨", "ä¸Šå®˜", "å¸é©¬", "ä¸œæ–¹", "ç‹¬å­¤", "å—å®«", "ä¸‡ä¿Ÿ", "é—»äºº", "å¤ä¾¯", "è¯¸è‘›", "å°‰è¿Ÿ", "å…¬ç¾Š", 
        "èµ«è¿", "æ¾¹å°", "çš‡ç”«", "å®—æ”¿", "æ¿®é˜³", "å…¬å†¶", "å¤ªå”", "ç”³å± ", "å…¬å­™", "æ…•å®¹", "ä»²å­™", "é’Ÿç¦»", "é•¿å­™", "å®‡æ–‡", 
        "å¸å¾’", "é²œäº", "å¸ç©º", "é—¾ä¸˜", "å­è½¦", "äº“å®˜", "å¸å¯‡", "å·«é©¬", "å…¬è¥¿", "é¢›å­™", "å£¤é©·", "å…¬è‰¯", "æ¼†é›•", "ä¹æ­£", 
        "å®°çˆ¶", "è°·æ¢", "æ‹“è·‹", "å¤¹è°·", "è½©è¾•", "ä»¤ç‹", "æ®µå¹²", "ç™¾é‡Œ", "å‘¼å»¶", "ä¸œéƒ­", "å—é—¨", "ç¾ŠèˆŒ", "å¾®ç”Ÿ", "å…¬æˆ·", 
        "å…¬ç‰", "å…¬ä»ª", "æ¢ä¸˜", "å…¬ä»²", "å…¬ä¸Š", "å…¬é—¨", "å…¬å±±", "å…¬åš", "å·¦ä¸˜", "å…¬ä¼¯", "è¥¿é—¨", "å…¬ç¥–", "ç¬¬äº”", "å…¬ä¹˜", 
        "è´¯ä¸˜", "å…¬æ™°", "å—è£", "ä¸œé‡Œ", "ä¸œå®«", "ä»²é•¿", "å­ä¹¦", "å­æ¡‘", "å³å¢¨", "è¾¾å¥š", "è¤šå¸ˆ", "å´é“­"
    ];

    function toCamel(text) {
        if (!text) return "";
        return text.replace(/[\u4e00-\u9fa5]/g, (char) => {
            const py = pinyin(char, { toneType: 'none', type: 'string' });
            return py.charAt(0).toUpperCase() + py.slice(1);
        });
    }

    function cleanPunctuation(str) {
        return str
            .replace(/ï¼Œ/g, ',')
            .replace(/ã€‚/g, '.')
            .replace(/ã€/g, ',')
            .replace(/ï¼š/g, ':')
            .replace(/[\uff01-\uff5e]/g, function(ch) { 
                return String.fromCharCode(ch.charCodeAt(0) - 0xfee0); 
            }) 
            .trim();
    }

    function processAll() {
        let raw = document.getElementById('input').value;
        let manualZip = document.getElementById('manualZip').value.trim();
        if (!raw) return;

        raw = cleanPunctuation(raw);

        // 1. æå–ç”µè¯
        let phone = "";
        const phoneRegex = /(1[3-9]\d{9})|(\d{3,4}-\d{7,8})/;
        const phoneMatch = raw.match(phoneRegex);
        if (phoneMatch) {
            phone = phoneMatch[0];
            raw = raw.replace(phone, " "); 
        }

        // 2. æå–é‚®ç¼–
        let zip = manualZip;
        if (!zip) {
            const zipRegex = /\d{6}/;
            const zipMatch = raw.match(zipRegex);
            if (zipMatch) {
                zip = zipMatch[0];
                raw = raw.replace(zip, " ");
            }
        }

        // 3. æå–çœ
        let provinceRaw = "";
        const provRegex = /(.{2,3}?(çœ|è‡ªæ²»åŒº|è¡Œæ”¿åŒº))/;
        const provMatch = raw.match(provRegex);
        if (provMatch) {
            provinceRaw = provMatch[1];
            raw = raw.replace(provinceRaw, " ");
        }

        // 4. æå–å¸‚
        let cityRaw = "";
        const cityRegex = /(.{2,3}?(å¸‚|å·|ç›Ÿ|åœ°åŒº))/;
        const cityMatch = raw.match(cityRegex);
        if (cityMatch) {
            cityRaw = cityMatch[1];
            raw = raw.replace(cityRaw, " ");
        }

        // 5. æå–å§“å (åŠ å¼ºç‰ˆé€»è¾‘)
        let surnameRaw = "";
        let firstNameRaw = "";
        
        raw = raw.trim();
        // æ’é™¤åœ°å€å…³é”®è¯ï¼Œé˜²æ­¢æŠŠåœ°å€å½“åå­—
        const addrKeywords = ['åŒº', 'å¿', 'è·¯', 'è¡—', 'å·', 'å®¤', 'é•‡', 'æ‘'];
        const startChars = raw.substring(0, 4);
        let looksLikeAddress = false;
        for (let kw of addrKeywords) {
            if (startChars.includes(kw)) looksLikeAddress = true;
        }

        if (!looksLikeAddress) {
            // åŒ¹é…å¤´éƒ¨ä¸­æ–‡
            const nameMatch = raw.match(/^([\u4e00-\u9fa5]{2,4})(\s|$)/);
            if (nameMatch) {
                const fullName = nameMatch[1];
                raw = raw.replace(fullName, "").trim();

                // æ‹†åˆ†å§“å’Œå
                let foundCompound = false;
                for (let cs of COMPOUND_SURNAMES) {
                    if (fullName.startsWith(cs)) {
                        surnameRaw = cs;
                        firstNameRaw = fullName.slice(cs.length);
                        foundCompound = true;
                        break;
                    }
                }
                if (!foundCompound) {
                    surnameRaw = fullName.charAt(0);
                    firstNameRaw = fullName.slice(1);
                }
            }
        }

        // 6. è¯¦ç»†åœ°å€åˆ‡åˆ† (ä¿®å¤â€œè¡—é“â€é—®é¢˜)
        // ä¼˜å…ˆçº§ï¼šå…ˆåŒ¹é…é•¿è¯(2å­—)ï¼Œå†åŒ¹é…çŸ­è¯(1å­—)
        const longKeywords = ['è¡—é“', 'ç¤¾åŒº', 'æ–°åŒº', 'å¤§å¦', 'ä¸­å¿ƒ', 'å¹¿åœº', 'å•å…ƒ', 'èŠ±å›­', 'å°åŒº'];
        const shortKeywords = ['åŒº', 'å¿', 'å¸‚', 'é•‡', 'æ‘', 'è·¯', 'è¡—', 'å··', 'é“', 'æ®µ', 'å¼„', 'å·', 'æ ‹', 'åº§', 'æ¥¼', 'å®¤', 'æˆ¿', 'å±‚', 'è‹‘'];
        
        let parts = [];
        let currentPart = "";
        
        for (let i = 0; i < raw.length; i++) {
            const char = raw[i];
            if (char === ' ' || char === ',') continue;

            currentPart += char;

            // æ£€æŸ¥åŒå­—åç¼€ (å¦‚ï¼šè¡—é“)
            // çœ‹æœªæ¥ä¸€ä¸ªå­—
            if (i < raw.length - 1) {
                const twoChars = char + raw[i+1];
                if (longKeywords.includes(twoChars)) {
                    // å‘ç°åŒå­—åç¼€ï¼ŒæŠŠä¸‹ä¸€ä¸ªå­—ä¹ŸåŠ ä¸Š
                    currentPart += raw[i+1];
                    parts.push(currentPart);
                    currentPart = "";
                    i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå­—
                    continue;
                }
            }

            // æ£€æŸ¥å•å­—åç¼€ (å¦‚ï¼šè¡—)
            // ä½†å¦‚æœå‰é¢å·²ç»åŒ¹é…äº†åŒå­—ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œåˆ°
            if (shortKeywords.includes(char)) {
                // å¦‚æœæ˜¯æ•°å­—+å…³é”®è¯(å¦‚1å·)ï¼Œæˆ–è€…æ–‡å­—+å…³é”®è¯
                parts.push(currentPart);
                currentPart = "";
            }
        }
        if (currentPart) parts.push(currentPart);


        // --- è½¬æ¢æ‹¼éŸ³ ---
        
        // 1. å§“å
        const p_surname = toCamel(surnameRaw);
        const p_firstname = toCamel(firstNameRaw);
        const p_fullName = (p_surname + " " + p_firstname).trim(); // ä¸­é—´åŠ ç©ºæ ¼

        // 2. çœå¸‚
        let p_prov = toCamel(provinceRaw);
        if (p_prov.endsWith("Sheng")) p_prov = p_prov.slice(0, -5);

        let p_city = toCamel(cityRaw);
        if (p_city.endsWith("Shi")) p_city = p_city.slice(0, -3);

        // 3. è¯¦ç»†åœ°å€
        let p_details = parts.map(part => {
             return part.replace(/([\u4e00-\u9fa5]+)|([0-9a-zA-Z]+)/g, (m, ch, num) => {
                 if (ch) return toCamel(ch);
                 return m;
             });
        }).filter(p => p).join(", "); 

        // --- ç»„è£…æœ€ç»ˆç»“æœ ---
        // é¡ºåºï¼šProv City Detail1, Detail2... Zip
        // åå­—å’Œç”µè¯ä¸æ”¾åœ¨åœ°å€è¡Œé‡Œï¼Œé™¤éä½ æœ‰ç‰¹æ®Šè¦æ±‚ï¼ˆé€šå¸¸åœ°å€è¡Œä¸å«åå­—ï¼‰
        // æŒ‰ç…§ä¹‹å‰çš„è¦æ±‚ï¼Œè¿™é‡Œåªæ”¾åœ°å€
        
        let fullLineArr = [];
        if (p_prov) fullLineArr.push(p_prov);
        if (p_city) fullLineArr.push(p_city);
        
        let header = fullLineArr.join(" "); 
        let finalAddress = header;
        
        if (p_details) {
            finalAddress += " " + p_details; // å¸‚åé¢ç”¨ç©ºæ ¼è¿æ¥è¯¦ç»†åœ°å€
        }
        if (zip) {
            finalAddress += " " + zip;
        }

        document.getElementById('fullResult').value = finalAddress;

        // å¡«å……æ‹†åˆ†å­—æ®µ
        setText('resSurname', p_surname);
        setText('resFirstName', p_firstname);
        setText('resPhone', phone);
        setText('resProv', p_prov);
        setText('resCity', p_city);
        setText('resAddr', p_details);
        setText('resZip', zip);
    }

    function setText(id, val) {
        document.getElementById(id).textContent = val || "-";
    }

    function copyText(elementId) {
        const el = document.getElementById(elementId);
        let text = (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') ? el.value : el.innerText;
        if(text === "-") text = "";
        if (!text) return;

        navigator.clipboard.writeText(text).then(() => {
            const originalColor = el.style.backgroundColor;
            el.style.backgroundColor = "#dcfce7"; 
            setTimeout(() => el.style.backgroundColor = originalColor, 200);
        });
    }

    function searchZip() {
        const raw = document.getElementById('input').value;
        if(raw) window.open(`https://www.baidu.com/s?wd=${encodeURIComponent(raw + ' é‚®ç¼–')}`, '_blank');
        else alert("è¯·å…ˆè¾“å…¥åœ°å€å†…å®¹");
    }

    function clearAll() {
        document.getElementById('input').value = "";
        document.getElementById('manualZip').value = "";
        document.getElementById('fullResult').value = "";
        ['resSurname','resFirstName','resPhone','resProv','resCity','resAddr','resZip'].forEach(id => {
            document.getElementById(id).textContent = "";
        });
        document.getElementById('input').focus();
    }
</script>

</body>
</html>
